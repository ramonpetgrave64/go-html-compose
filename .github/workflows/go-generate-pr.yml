name: Auto Go Generate PR

on:
  schedule:
    - cron: "0 0 * * 0"
  workflow_dispatch:

jobs:
  go-generate-diff:
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: actions/setup-go@cd53bc84d5e2fd85362f4cb840513e06427082d3 # v5.4.0
        with:
          go-version-file: pkg/generate/go.mod
      - run: go generate ./...
      - id: diff
        run: git diff --exit-code "*.go"
        continue-on-error: true
      - if: ${{ steps.diff.outcome == 'failure' }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git add .
          git config user.name github-actions
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -sm "update from spec"
          git checkout -b auto-go-generate
          git push --set-upstream -f origin auto-go-generate
      - env:
          # token must be a PAT with permissions to create PRs on this repo.
          GH_TOKEN: ${{ secrets.PR_TOKEN }}
        run: |
          gh pr create \
            --draft \
            --assignee "@me" \
            --repo ${{ github.repository }} \
            --base "main" \
            --head "auto-go-generate" \
            --title "auto-gen: update from spec" \
            --body "PR autogenerated by workflow '${{ github.workflow }}' to update from the HMTL spec."
